<head>
    <style> body { margin: 0; } </style>
    <script src="//cdn.jsdelivr.net/npm/3d-force-graph"></script>
  </head>
  
  <body>
    <div id="3d-graph"></div>
  
    <script type="module">
      import * as THREE from 'https://esm.sh/three';

      function makeGlowSprite(color, size) {
        const glowMaterial = new THREE.SpriteMaterial({
          color,
          transparent: true,
          opacity: 0.2,
          depthWrite: false
        });
        const glowSprite = new THREE.Sprite(glowMaterial);
        glowSprite.scale.set(size * 1.2, size * 1.2);
        return glowSprite;
      }

      const Graph = ForceGraph3D()(document.getElementById('3d-graph'))
        .nodeThreeObject(({ name }) => {
          const file = name.startsWith('figures/') ? name : `figures/${name}`;
          const imgTexture = new THREE.TextureLoader().load(`../${file}`);
          imgTexture.colorSpace = THREE.SRGBColorSpace;
          const material = new THREE.SpriteMaterial({ map: imgTexture, depthWrite: false });

          const group = new THREE.Group();
          const sprite = new THREE.Sprite(material);
          const size = 30;
          sprite.scale.set(size, size);
          group.add(sprite);

          const glow = makeGlowSprite(0xffffff, size);
          group.add(glow);

          return group;
        })
        .nodeThreeObjectExtend(false)
        .onNodeClick(node => {
          const distance = 40;
          const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);

          const newPos = node.x || node.y || node.z
            ? { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }
            : { x: 0, y: 0, z: distance }; 

          Graph.cameraPosition(
            newPos, 
            node,
            3000  
          );
        });
      
      Graph.d3VelocityDecay(.8); 
      Graph.d3AlphaDecay(0.0);   
      Graph.cooldownTime(15000);
      Graph.d3Force('charge').strength(-120);
      
      fetch('figures.json')
        .then(res => res.json())
        .then(data => Graph.graphData(data));
      
      const ORBIT_DISTANCE = 700;
      const ORBIT_STEP = Math.PI / 480;
      let orbitAngle = 0;
      let orbitPauseUntil = 0;

      const orbitCamera = () => {
        const now = performance.now();
        if (now >= orbitPauseUntil) {
          const x = ORBIT_DISTANCE * Math.sin(orbitAngle);
          const z = ORBIT_DISTANCE * Math.cos(orbitAngle);
          Graph.cameraPosition({ x, y: ORBIT_DISTANCE * 0.05, z });
          orbitAngle += ORBIT_STEP;
        }
        requestAnimationFrame(orbitCamera);
      };

    </script>
  </body>
